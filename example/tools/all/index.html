<!DOCTYPE HTML>
<html>
<head>
    <!-- twitter bootstrap CSS stylesheet - not required by cornerstone -->
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">


    <style>
        /* prevents selection when left click dragging */
        .disable-selection {
            -moz-user-select: none; -webkit-user-select: none; -ms-user-select:none; user-select:none;
        }
        /* prevents cursor from changing to the i bar on the overlays*/
        .noIbar {
            cursor:default;
        }
    </style>
</head>
<body>
<div class="container">

    <h1>
        tools/all/index.html
    </h1>
    This example illustrates most of cornerstone's functionality all in one page.
    <br>
    <br>
    <strong>Please use Google Chrome if possible
    as this is the primary browser used for development and testing for other browsers is not done as regularly.</strong>
    <br>
    <br>

    Functionality:
    <ul>
        <li>Activation of different tools via buttons
            <ul>
                <li>WW/WC - Adjust the window width and window center of the image</li>
                <li>Length - Length measurement tool</li>
                <li>Probe - Display the image x,y coordinate under cursor as well as the pixel value (stored pixel and modality)</li>
                <li>Elliptical ROI - An elliptical ROI that shows mean, stddev and area</li>
                <li>Rectangle ROI - A rectangular ROI that shows mean, stddev and area</li>
            </ul>
        </li>
        <li>Use the activated tool by dragging the left mouse button</li>
        <li>Pan by dragging the middle mouse button</li>
        <li>Zoom by dragging the right mouse button</li>
        <li>Text overlays in the four corners using HTML elements updated by listening for the CornerstoneViewportUpdated event</li>
        <li>Adding a custom annotation "Tumor Here" with rectangle to the element by responding to the CornerstoneViewportUpdated event </li>
        <li>Initializing the length tool with a previously created length measurement</li>
        <li>Stack functionality
            <ul>
                <li>Change to different stacks and images in those stacks rolling the mouse wheel (there are two stacks - one with two MRI images and one with a single CT image</li>
                <li>Stack specific length measurement.  A length measurement made on an MRI image is visible on both MRI images but not the CT image</li>
                <li>Preservation of the viewport settings when changing images in the same stack</li>
                <li>automatically resizing the viewport when scrolling to another stack (the CT image is 512x512 and the MRI is 256x256)</li>
            </ul>
        </li>
        <li>Tool dragging</li>
        <li>Tool handles (partially implemented)</li>
        <li>Tool deletion (not implemented yet)</li>
    </ul>

    <br>
    <br>

    <button id="enableWindowLevelTool" type="button" class="btn">WW/WC</button>
    <button id="enableLength" type="button" class="btn">Length</button>
    <button id="probe" type="button" class="btn">Probe</button>
    <button id="circleroi" type="button" class="btn">Elliptical ROI</button>
    <button id="rectangleroi" type="button" class="btn">Rectangle ROI</button>

    <br>
    <div style="width:512px;height:512px;position:relative;color: white;display:inline-block"
         oncontextmenu="return false"
         class='disable-selection noIbar'
         unselectable='on'
         onselectstart='return false;'
         onmousedown='return false;'>
        <div id="dicomImage"
             style="width:512px;height:512px;top:0px;left:0px; position:absolute">
        </div>
        <div id="mrtopleft" style="position: absolute;top:0px; left:0px">
            Patient Name
        </div>
        <div id="mrtopright" style="position: absolute;top:0px; right:0px">
            Hospital
        </div>
        <div id="mrbottomright" style="position: absolute;bottom:0px; right:0px">
            Zoom:
        </div>
        <div id="mrbottomleft" style="position: absolute;bottom:0px; left:0px">
            WW/WC:
        </div>

    </div>

</body>

<!-- jquery - included to make things easier to demo, needed by cornerstone tools -->
<script src="https://code.jquery.com/jquery-2.1.0.min.js"></script>

<!-- include the cornerstone library -->
<script src="../../../dist/cornerstone.js"></script>

<!-- include the cornerstone tools library -->
<script src="../../../dist/cornerstone-tools.js"></script>

<!-- include special code for these examples which provides images -->
<script src="../../exampleImageIdLoader.js"></script>

<!-- include special code for these examples which provides images -->
<script src="../../exampleImageIdLoaderCt.js"></script>


<script>
    var element = $('#dicomImage').get(0);

    // Listen for changes to the viewport so we can update the text overlays in the corner
    function onViewportUpdated(e) {
        $('#mrbottomleft').text("WW/WL:" + Math.round(e.detail.viewport.windowWidth) + "/" + Math.round(e.detail.viewport.windowCenter));
        $('#mrbottomright').text("Zoom:" + e.detail.viewport.scale.toFixed(2));
    };
    element.addEventListener("CornerstoneViewportUpdated", onViewportUpdated, false);

    // Listen for image render events so we can add out "Tumor Here" and rectangle overlay to the rendered image
    function onImageRendered(e) {
        // set the canvas context to the image coordinate system
        cornerstoneCore.setToPixelCoordinateSystem(e.detail.enabledElement, e.detail.canvasContext);

        // NOTE: The coordinate system of the canvas is in image pixel space.  Drawing
        // to location 0,0 will be the top left of the image and rows,columns is the bottom
        // right.
        var context = e.detail.canvasContext;
        context.beginPath();
        context.strokeStyle = 'white';
        context.lineWidth = 1;
        context.rect(128,90,50,60);
        context.stroke();
        context.fillStyle = "white";
        context.font = "6px Arial";
        context.fillText("Tumor Here", 128, 85);
    };
    element.addEventListener("CornerstoneImageRendered", onImageRendered, false);


    // Declare two stacks, one with two MRI images and another with a single CT image
    var stack1 = {
        stackId : '1',
        imageIds : [
            'example://1',
            'example://2']
    };

    var stack2 = {
        stackId: '2',
        imageIds: [
            'ctexample://1']
    };

    var stacks = [
        stack1,
        stack2];


    // image enable the dicomImage element
    cornerstone.enable(element, stack1.imageIds[0]);

    // Enable all tools we want to use with this element
    cornerstoneTools.length.deactivate(element);
    cornerstoneTools.ellipticalRoi.enable(element);
    cornerstoneTools.rectangleRoi.enable(element);
    cornerstoneTools.probe.enable(element);
    cornerstoneTools.wwwc.activate(element, 1); // important to do ww/wc last for now, probably need separate event for the 'active' tool vs the rest

    cornerstoneTools.pan.activate(element, 2);
    cornerstoneTools.zoom.activate(element, 3);
    cornerstoneTools.scroll(element, stacks, 0);


    // helper function used by the tool button handlers to disable the active tool
    // before making a new tool active
    function disableAllTools()
    {
        cornerstoneTools.wwwc.disable(element);
        cornerstoneTools.length.deactivate(element);
        cornerstoneTools.ellipticalRoi.deactivate(element);
        cornerstoneTools.rectangleRoi.deactivate(element);
        cornerstoneTools.probe.deactivate(element);
    }

    // Tool button event handlers that set the new active tool
    $('#enableLength').click(function() {
        disableAllTools();
        cornerstoneTools.length.activate(element, 1);
    });
    $('#enableWindowLevelTool').click(function() {
        disableAllTools();
        cornerstoneTools.windowWidthWindowCenter(element, 1);
    });
    $('#probe').click(function() {
        disableAllTools();
        cornerstoneTools.probe.activate(element, 1);
    });
    $('#circleroi').click(function() {
        disableAllTools();
        cornerstoneTools.ellipticalRoi.activate(element, 1);
    });
    $('#rectangleroi').click(function() {
        disableAllTools();
        cornerstoneTools.rectangleRoi.activate(element, 1);
    });

    // add a measurement to the image - this is showing tool state restore
    var data = {
        visible : true,
        handles : {
            start : {
                x : 152.5,
                y : 148.5,
                active: false
            },
            end: {
                x : 155.5,
                y : 91.5,
                active: false
            }
        }
    };
    cornerstoneTools.addToolState(element, 'length', data);
    cornerstone.updateImage(element);


</script>
</html>
