var cornerstoneTools=function(a,b,c,d){function e(c){var d=c.currentTarget,e=b.getElementData(d,"ellipticalRoi");if(c.which==e.whichMouseButton){var f=b.pageToImage(d,c.pageX,c.pageY);e.startX=f.x,e.startY=f.y,e.endX=f.x,e.endY=f.y,e.lengthVisible=!0,a(document).mousemove(function(a){var c=b.pageToImage(d,a.pageX,a.pageY);e.endX=c.x,e.endY=c.y,b.updateImage(d)}),a(document).mouseup(function(){a(document).unbind("mousemove"),a(document).unbind("mouseup")})}}function f(a,b){var c=a.width/2,d=a.height/2;if(0>=c||0>=d)return!1;var e={x:a.left+c,y:a.top+d},f={x:b.x-e.x,y:b.y-e.y},g=f.x*f.y/(c*c)+f.y*f.y/(d*d)<=1;return g}function g(a,b){for(var c=0,d=0,e=0,g=0,h=b.top;h<b.top+b.height;h++)for(var i=b.left;i<b.left+b.width;i++)1==f(b,{x:i,y:h})&&(c+=a[g],d+=a[g]*a[g],e++),g++;if(0==e)return{count:e,mean:0,variance:0,stdDev:0};var j=c/e,k=d/e-j*j;return{count:e,mean:j,variance:k,stdDev:Math.sqrt(k)}}function h(a){var d=b.getElementData(a.currentTarget,"ellipticalRoi");if(0!=d.lengthVisible){c.setToPixelCoordinateSystem(a.detail.enabledElement,a.detail.canvasContext);var e=Math.abs(d.startX-d.endX),f=Math.abs(d.startY-d.endY),h=Math.min(d.startX,d.endX),i=Math.min(d.startY,d.endY),j=(d.startX+d.endX)/2,k=(d.startY+d.endY)/2,l=a.detail.canvasContext;l.beginPath(),l.strokeStyle="white",l.lineWidth=1/a.detail.viewport.scale,l.beginPath(),c.drawEllipse(l,h,i,e,f),l.stroke(),l.fillStyle="white";var m=b.getStoredPixels(a.detail.element,h,i,e,f),n={left:h,top:i,width:e,height:f},o=g(m,n),p=Math.PI*(e*a.detail.image.columnPixelSpacing/2)*(f*a.detail.image.rowPixelSpacing/2),q="Area: "+p.toFixed(2)+" mm^2",r=c.setToFontCoordinateSystem(a.detail.enabledElement,a.detail.canvasContext,15);l.font=""+r.fontSize+"px Arial";var s=l.measureText(p),t=r.lineHeight,u=j<a.detail.image.columns/2?j+e/2:j-e/2-s.width*r.fontScale,v=k<a.detail.image.rows/2?k+f/2:k-f/2;u/=r.fontScale,v/=r.fontScale,l.fillText("Mean: "+o.mean.toFixed(2),u,v-t),l.fillText("StdDev: "+o.stdDev.toFixed(2),u,v),l.fillText(q,u,v+t)}}function i(c,d){c.addEventListener("CornerstoneImageRendered",h,!1);var f={whichMouseButton:d,lengthVisible:!1,startX:0,startY:0,endX:0,endY:0},g=b.getElementData(c,"ellipticalRoi");for(var i in f)g[i]=f[i];a(c).mousedown(e)}function j(c){c.removeEventListener("CornerstoneImageRendered",h),a(c).unbind("mousedown",e),b.removeElementData(c,"ellipticalRoi")}return void 0===d&&(d={}),d.enableEllipticalRoi=i,d.disableEllipticalRoi=j,d}($,cornerstone,cornerstoneCore,cornerstoneTools),cornerstoneTools=function(a,b,c,d){function e(a,b,d){var e=j/d;for(var f in a){var g=a[f],h=c.distance(b,g);if(e>=h)return g}return void 0}function f(a){for(var b in a){var c=a[b];if(c.active===!0)return c}return void 0}function g(a,b,c){var d=f(a),g=e(a,b,c);return d!=g?(void 0!==g&&(g.active=!0),void 0!=d&&(d.active=!1),!0):!1}function h(c,e,f,g){if(e.visible===!1)return!1;var h=d.findHandleNear(e.handles,f,g);return void 0==h?!1:(a(document).mousemove(function(a){var c=b.pageToImage(element,a.pageX,a.pageY);h.x=c.x,h.y=c.y,b.updateImage(element)}),a(document).mouseup(function(){a(document).unbind("mousemove"),a(document).unbind("mouseup")}),!0)}function i(a,b,c){a.strokeStyle="white",a.lineWidth=1/b.scale;var d=j/b.scale;for(var e in c){var f=c[e];1==f.active&&a.arc(f.x,f.y,d,0,2*Math.PI)}}void 0===d&&(d={});var j=6;return d.findHandleNear=e,d.handleCursorNearHandle=h,d.drawHandles=i,d.activateNearbyHandle=g,d}($,cornerstone,cornerstoneCore,cornerstoneTools),cornerstoneTools=function(a,b,c,d){function e(){function a(a,c,e){var f=b.getEnabledElement(a);0==d.hasOwnProperty(f.ids.imageId)&&(d[f.ids.imageId]={});var g=d[f.ids.imageId];0==g.hasOwnProperty(c)&&(g[c]={data:[]});var h=g[c];h.data.push(e)}function c(a,c){var e=b.getEnabledElement(a);if(0==d.hasOwnProperty(e.ids.imageId))return void 0;var f=d[e.ids.imageId];if(0==f.hasOwnProperty(c))return void 0;var g=f[c];return g}var d={},e={get:c,add:a};return e}void 0===d&&(d={});var f=e();return d.newImageIdSpecificToolStateManager=e,d.globalImageIdSpecificToolStateManager=f,d}($,cornerstone,cornerstoneCore,cornerstoneTools),cornerstoneTools=function(a,b,c,d){function e(a,b,c){var e={visible:!0,handles:{start:{x:b.x,y:b.y,active:!1},end:{x:b.x,y:b.y,active:!0}}};d.addToolState(a.currentTarget,m,e),d.handleCursorNearHandle(a,e,b,c)}function f(a){var c=a.data;if(a.which==c.whichMouseButton){var f=a.currentTarget,g=b.getViewport(f),h=b.pageToImage(f,a.pageX,a.pageY),i=d.getToolState(a.currentTarget,m);if(void 0!==i)for(var j=0;j<i.data.length;j++){var k=i.data[j];if(1==d.handleCursorNearHandle(a,k,h,g.scale))return void a.stopPropagation()}if(c.active===!0)return e(a,h,g.scale),void a.stopPropagation()}}function g(a){var b=d.getToolState(a.currentTarget,m);if(void 0!==b){var e=a.detail.canvasContext.canvas.getContext("2d");c.setToPixelCoordinateSystem(a.detail.enabledElement,e);for(var f=0;f<b.data.length;f++){e.save();var g=b.data[f];e.beginPath(),e.strokeStyle="white",e.lineWidth=1/a.detail.viewport.scale,e.moveTo(g.handles.start.x,g.handles.start.y),e.lineTo(g.handles.end.x,g.handles.end.y),e.stroke(),e.beginPath(),d.drawHandles(e,a.detail.viewport,g.handles,a.detail.viewport.scale),e.stroke(),e.fillStyle="white";var h=g.handles.start.x-g.handles.end.x*a.detail.image.columnPixelSpacing,i=g.handles.start.y-g.handles.end.y*a.detail.image.rowPixelSpacing,j=Math.sqrt(h*h+i*i),k=""+j.toFixed(2)+" mm",l=c.setToFontCoordinateSystem(a.detail.enabledElement,a.detail.canvasContext,15);e.font=""+l.fontSize+"px Arial";var n=(g.handles.start.x+g.handles.end.x)/2/l.fontScale,o=(g.handles.start.y+g.handles.end.y)/2/l.fontScale;e.fillText(k,n,o),e.restore()}}}function h(a){if(0==a.which){var c=d.getToolState(a.currentTarget,m);if(void 0!==c){for(var e=!1,f=0;f<c.data.length;f++){var g=b.pageToImage(element,a.pageX,a.pageY),h=b.getViewport(element),i=c.data[f];1==d.activateNearbyHandle(i.handles,g,h.scale)&&(e=!0)}e===!0&&b.updateImage(element)}}}function i(c){c.addEventListener("CornerstoneImageRendered",g,!1),a(c).mousemove(h),b.updateImage(c),l(c)}function j(c){l(c),a(c).unbind("mousemove",h),c.removeEventListener("CornerstoneImageRendered",g),b.updateImage(c)}function k(b,c){var d={whichMouseButton:c,active:!0};a(b).unbind("mousedown",f),a(b).mousedown(d,f)}function l(b){var c={whichMouseButton:1,active:!1};a(b).unbind("mousedown",f),a(b).mousedown(c,f)}void 0===d&&(d={});var m="length";return d.length={enable:i,disable:j,activate:k,deactivate:l},d}($,cornerstone,cornerstoneCore,cornerstoneTools),cornerstoneTools=function(a,b,c){function d(c,d){a(c).mousedown(function(e){var f=e.pageX,g=e.pageY,h=e.which;h==d&&(a(document).mousemove(function(a){var d=a.pageX-f,e=a.pageY-g;f=a.pageX,g=a.pageY;var h=b.getViewport(c);h.centerX+=d/h.scale,h.centerY+=e/h.scale,b.setViewport(c,h)}),a(document).mouseup(function(){a(document).unbind("mousemove"),a(document).unbind("mouseup")}))})}return void 0===c&&(c={}),c.pan=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){function e(c){var d=c.currentTarget,e=b.getElementData(d,"probe");if(c.which==e.whichMouseButton){var f=b.pageToImage(d,c.pageX,c.pageY);e.x=f.x,e.y=f.y,e.visible=!0,b.updateImage(d),a(document).mousemove(function(a){var c=b.pageToImage(d,a.pageX,a.pageY);e.x=c.x,e.y=c.y,b.updateImage(d)}),a(document).mouseup(function(){e.visible=!1,b.updateImage(d),a(document).unbind("mousemove"),a(document).unbind("mouseup")})}}function f(a){var d=b.getElementData(a.currentTarget,"probe");if(0!=d.visible){c.setToPixelCoordinateSystem(a.detail.enabledElement,a.detail.canvasContext);var e=a.detail.canvasContext;e.beginPath(),e.stroke();var f=c.setToFontCoordinateSystem(a.detail.enabledElement,a.detail.canvasContext,15);e.font=""+f.fontSize+"px Arial";var g=Math.round(d.x),h=Math.round(d.y),i=b.getStoredPixels(a.detail.element,g,h,1,1),j=i[0],k=j*a.detail.image.slope+a.detail.image.intercept,l=(g+3)/f.fontScale,m=(h-3)/f.fontScale-f.lineHeight;e.fillStyle="white",e.fillText(""+g+","+h,l,m),e.fillText("SP: "+j+" MO: "+k,l,m+f.lineHeight)}}function g(c,d){c.addEventListener("CornerstoneImageRendered",f,!1);var g={whichMouseButton:d,visible:!1,x:0,y:0},h=b.getElementData(c,"probe");for(var i in g)h[i]=g[i];a(c).mousedown(e)}function h(c){c.removeEventListener("CornerstoneImageRendered",f),a(c).unbind("mousedown",e),b.removeElementData(c,"probe")}return void 0===d&&(d={}),d.enableProbe=g,d.disableProbe=h,d}($,cornerstone,cornerstoneCore,cornerstoneTools),cornerstoneTools=function(a,b,c,d){function e(c){var d=c.currentTarget,e=b.getElementData(d,"rectangleRoi");if(c.which==e.whichMouseButton){var f=b.pageToImage(d,c.pageX,c.pageY);e.startX=f.x,e.startY=f.y,e.endX=f.x,e.endY=f.y,e.lengthVisible=!0,a(document).mousemove(function(a){var c=b.pageToImage(d,a.pageX,a.pageY);e.endX=c.x,e.endY=c.y,b.updateImage(d)}),a(document).mouseup(function(){a(document).unbind("mousemove"),a(document).unbind("mouseup")})}}function f(a,b){if(0==f)return{count:f,mean:0,variance:0,stdDev:0};for(var c=Math.round(2*b),d=0,e=0,f=0,g=0,h=0;c>h;h++)for(var i=0;c>i;i++)d+=a[g],e+=a[g]*a[g],f++,g++;var j=d/f,k=e/f-j*j;return{count:f,mean:j,variance:k,stdDev:Math.sqrt(k)}}function g(a){var d=b.getElementData(a.currentTarget,"rectangleRoi");if(0!=d.lengthVisible){c.setToPixelCoordinateSystem(a.detail.enabledElement,a.detail.canvasContext);var e=Math.abs(d.startX-d.endX),g=Math.abs(d.startY-d.endY),h=Math.max(e,g)/2,i=(d.startX+d.endX)/2,j=(d.startY+d.endY)/2,k=Math.min(d.startX,d.endX),l=Math.min(d.startY,d.endY),m=a.detail.canvasContext;m.beginPath(),m.strokeStyle="white",m.lineWidth=1/a.detail.viewport.scale,m.rect(k,l,e,g),m.stroke(),m.fillStyle="white";var n=c.setToFontCoordinateSystem(a.detail.enabledElement,a.detail.canvasContext,15);m.font=""+n.fontSize+"px Arial";var o=e*a.detail.image.columnPixelSpacing*g*a.detail.image.rowPixelSpacing,o="Area: "+o.toFixed(2)+" mm^2",p=m.measureText(o),q=n.lineHeight,r=i<a.detail.image.columns/2?i+e/2:i-e/2-p.width*n.fontScale,s=j<a.detail.image.rows/2?j+g/2:j-g/2;r/=n.fontScale,s/=n.fontScale;var t=b.getStoredPixels(a.detail.element,i-h,j-h,2*h,2*h),u=f(t,h);m.fillText("Mean: "+u.mean.toFixed(2),r,s-q),m.fillText("StdDev: "+u.stdDev.toFixed(2),r,s),m.fillText(o,r,s+q)}}function h(c,d){c.addEventListener("CornerstoneImageRendered",g,!1);var f={whichMouseButton:d,lengthVisible:!1,startX:0,startY:0,endX:0,endY:0},h=b.getElementData(c,"rectangleRoi");for(var i in f)h[i]=f[i];a(c).mousedown(e)}function i(c){c.removeEventListener("CornerstoneImageRendered",g),a(c).unbind("mousedown",e),b.removeElementData(c,"rectangleRoi")}return void 0===d&&(d={}),d.enableRectangleRoi=h,d.disableRectangleRoi=i,d}($,cornerstone,cornerstoneCore,cornerstoneTools),cornerstoneTools=function(a,b,c){function d(d,e,f){var g=0,h=0,i=[],j=c.getElementToolStateManager(d);void 0===j&&(j=c.globalImageIdSpecificToolStateManager);var k=["length"];e.forEach(function(){var a=c.newStackSpecificToolStateManager(k,j);i.push(a)}),c.setElementToolStateManager(d,i[0]),0==f&&a(d).on("mousewheel DOMMouseScroll",function(a){var f=e[h];return a.originalEvent.wheelDelta<0||a.originalEvent.detail>0?g<f.imageIds.length-1?(g++,b.newStackImage(d,f.imageIds[g])):h<e.length-1&&(h++,f=e[h],g=0,c.setElementToolStateManager(d,i[h]),b.newStack(d,f.imageIds[g])):g>0?(g--,b.newStackImage(d,f.imageIds[g])):h>0&&(h--,f=e[h],g=f.imageIds.length-1,c.setElementToolStateManager(d,i[h]),b.newStack(d,f.imageIds[g])),!1})}return void 0===c&&(c={}),c.scroll=d,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c,d){function e(a,c){function d(d,e,g){if(!(a.indexOf(e)>=0))return c.get(d,e,g);b.getEnabledElement(d);0==f.hasOwnProperty(e)&&(f[e]={data:[]});var h=f[e];h.data.push(g)}function e(b,d){if(a.indexOf(d)>=0){0==f.hasOwnProperty(d)&&(f[d]={data:[]});var e=f[d];return e}return c.add(b,d,data)}var f={},g={get:e,add:d};return g}return void 0===d&&(d={}),d.newStackSpecificToolStateManager=e,d}($,cornerstone,cornerstoneCore,cornerstoneTools),cornerstoneTools=function(a,b,c,d){function e(a){var c=b.getEnabledElement(a);return void 0===c.toolStateManager&&(c.toolStateManager=d.globalImageIdSpecificToolStateManager),c.toolStateManager}function f(a,b,c){toolStateManager=e(a),toolStateManager.add(a,b,c)}function g(a,b){return toolStateManager=e(a),toolStateManager.get(a,b,data)}function h(a,c){var d=b.getEnabledElement(a);d.toolStateManager=c}return void 0===d&&(d={}),d.addToolState=f,d.getToolState=g,d.setElementToolStateManager=h,d.getElementToolStateManager=e,d}($,cornerstone,cornerstoneCore,cornerstoneTools),cornerstoneTools=function(a,b,c){function d(c){var d=c.data.whichMouseButton,e=c.pageX,f=c.pageY,g=c.which;if(g==d){var h=c.currentTarget;a(document).mousemove(function(a){var c=a.pageX-e,d=a.pageY-f;e=a.pageX,f=a.pageY;var g=b.getViewport(h);g.windowWidth+=c/g.scale,g.windowCenter+=d/g.scale,b.setViewport(h,g)}),a(document).mouseup(function(){a(document).unbind("mousemove"),a(document).unbind("mouseup")})}}function e(b,c){var e={whichMouseButton:c};a(b).mousedown(e,d)}function f(b){a(b).unbind("mousedown",d)}return void 0===c&&(c={}),c.windowWidthWindowCenter=e,c.disableWindowWidthWindowCenter=f,c}($,cornerstone,cornerstoneTools),cornerstoneTools=function(a,b,c){function d(c,d){0==d?a(c).on("mousewheel DOMMouseScroll",function(a){var d=b.pageToImage(c,a.pageX,a.pageY),e=0,f=Math.abs(a.originalEvent.wheelDelta?a.originalEvent.wheelDelta/40:a.originalEvent.detail?-a.originalEvent.detail:0);e=a.originalEvent.wheelDelta<0||a.originalEvent.detail>0?f:-f;var g=1.005,h=b.getViewport(c),i=Math.log(h.scale)/Math.log(g),j=i+e,k=Math.pow(g,j);h.scale=k;var l=b.getEnabledElement(c);l.viewport.scale=k;var m=b.pageToImage(c,a.pageX,a.pageY);return h.centerX-=d.x-m.x,h.centerY-=d.y-m.y,b.setViewport(c,h),!1}):a(c).mousedown(function(e){var f=e.pageX,g=e.pageY,h=e.which;if(h==d){var i=b.pageToImage(c,e.pageX,e.pageY),j=e.pageX,k=e.pageY;a(document).mousemove(function(a){var d=(a.pageX-f,a.pageY-g);f=a.pageX,g=a.pageY;var e=1.7,h=b.getViewport(c),l=d/100,m=Math.log(h.scale)/Math.log(e),n=m+l,o=Math.pow(e,n);h.scale=o;var p=b.getEnabledElement(c);p.viewport.scale=o;var q=b.pageToImage(c,j,k);h.centerX-=i.x-q.x,h.centerY-=i.y-q.y,b.setViewport(c,h)}),a(document).mouseup(function(){a(document).unbind("mousemove"),a(document).unbind("mouseup")})}})}return void 0===c&&(c={}),c.zoom=d,c}($,cornerstone,cornerstoneTools);